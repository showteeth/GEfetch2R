---
title: "DownloadObjects"
output: html_document
date: "2023-07-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

`scfetch` provides functions for users to download processed single-cell RNA-seq data from [Zenodo](https://zenodo.org/), [CELLxGENE](https://cellxgene.cziscience.com/) and [Human Cell Atlas](https://www.humancellatlas.org/), including `RDS`, `RData`, `h5ad`, `h5`, `loom` objects. 

Until now, the public resources supported and the returned results:

<table>
<thead>
  <tr>
    <th>Resources</th>
    <th>URL</th>
    <th>Download Type</th>
    <th>Returned results</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>Zenodo</td>
    <td>https://zenodo.org/</td>
    <td>count matrix, rds, rdata, h5ad, et al.</td>
    <td>NULL or failed datasets</td>
  </tr>
  <tr>
    <td>CELLxGENE</td>
    <td>https://cellxgene.cziscience.com/</td>
    <td>rds, h5ad</td>
    <td>NULL or failed datasets</td>
  </tr>
  <tr>
    <td>Human Cell Atlas</td>
    <td>https://www.humancellatlas.org/</td>
    <td>rds, rdata, h5, h5ad, loom</td>
    <td>NULL or failed projects</td>
  </tr>
</tbody>
</table>

<hr />

## Zenodo

[Zenodo](https://zenodo.org/) contains various types of processed objects, such as `SeuratObject` which has been clustered and annotated, `AnnData` which contains processed results generated by `scanpy`.

### Extract metadata

`scfetch` provides `ExtractZenodoMeta` to extract dataset metadata, including dataset title, description, available files and corresponding md5. Please note that when the dataset is restricted access, the returned dataframe will be empty.

```{r zenodo_meta}
# library
library(scfetch)

# single doi
zebrafish.df <- ExtractZenodoMeta(doi = "10.5281/zenodo.7243603")
head(zebrafish.df)

# vector dois
multi.dois <- ExtractZenodoMeta(doi = c("1111", "10.5281/zenodo.7243603", "10.5281/zenodo.7244441"))
head(multi.dois)
```

<hr />

### Download object

After manually check the extracted metadata, users can **download the specified objects** with `ParseZenodo`. The downloaded objects are controlled by `file.ext` and **the provided object formats should be in lower case (e.g. rds/rdata/h5ad).**

The returned result is a dataframe containing failed objects. If not `NULL`, users can re-run `ParseZenodo` by setting `doi.df` to the returned result.

```{r zenodo_parse, eval=FALSE}
multi.dois.parse <- ParseZenodo(
  doi = c("1111", "10.5281/zenodo.7243603", "10.5281/zenodo.7244441"),
  file.ext = c("rdata", "rds"), out.folder = "/Users/soyabean/Desktop/tmp/scdown/download_zenodo"
)
```

The structure of downloaded objects:
```{bash zenodo_parse_structure}
tree /Users/soyabean/Desktop/tmp/scdown/download_zenodo
```

<hr />

## CELLxGENE

The [CELLxGENE](https://cellxgene.cziscience.com/) is a web server contains **910** single-cell datasets, users can explore, download and upload own datasets. The downloaded datasets provided by [CELLxGENE](https://cellxgene.cziscience.com/) have two formats: `h5ad (AnnData v0.8)` and `rds (Seurat v4)`.

### Show available datasets

`scfetch` provides `ShowCELLxGENEDatasets` to extract dataset metadata, including dataset title, description, contact, organism, ethnicity, sex, tissue, disease, assay, suspension type, cell type, et al.

```{r cellxgene_all}
# all available datasets
all.cellxgene.datasets <- ShowCELLxGENEDatasets()
```

<hr />

### Summary attributes

`scfetch` provides `StatDBAttribute` to summary attributes of [CELLxGENE](https://cellxgene.cziscience.com/):

```{r cellxgene_summary}
StatDBAttribute(df = all.cellxgene.datasets, filter = c("organism", "sex"), database = "CELLxGENE")
```

<hr />

### Extract metadata

`scfetch` provides `ExtractCELLxGENEMeta` to filter dataset metadata, the available values of attributes can be obtained with `StatDBAttribute` except **cell number**:

```{r cellxgene_meta}
# human 10x v2 and v3 datasets
human.10x.cellxgene.meta <- ExtractCELLxGENEMeta(
  all.samples.df = all.cellxgene.datasets,
  assay = c("10x 3' v2", "10x 3' v3"), organism = "Homo sapiens"
)
head(human.10x.cellxgene.meta)
```

<hr />

### Download object

After manually check the extracted metadata, users can **download the specified objects** with `ParseCELLxGENE`. The downloaded objects are controlled by `file.ext` (choose from `"rds"` and `"h5ad"`).

The returned result is a dataframe containing failed datasets. If not `NULL`, users can re-run `ParseCELLxGENE` by setting `meta` to the returned result.

```{r cellxgene_parse, eval=FALSE}
ParseCELLxGENE(
  meta = human.10x.cellxgene.meta[1:5, ], file.ext = "rds",
  out.folder = "/Users/soyabean/Desktop/tmp/scdown/download_cellxgene"
)
```

The structure of downloaded objects:
```{bash cellxgene_parse_structure}
tree /Users/soyabean/Desktop/tmp/scdown/download_cellxgene
```

<hr />

## Human Cell Atlas

The [Human Cell Atlas](https://www.humancellatlas.org/) aims to map every cell type in the human body, it contains **397 projects**, most of which are from `Homo sapiens` (also includes projects from `Mus musculus`, `Macaca mulatta` and `canis lupus familiaris`).

### Show available datasets

`scfetch` provides `ShowHCAProjects` to extract detailed project metadata, including project title, description, organism, sex, organ/organPart, disease, assay, preservation method, sample type, suspension type, cell type, development stage, et al.

There are **397 unique projects** under *five different catalogs (`dcp29`, `dcp30`, `dcp1`, `lm2`, `lm3`)*:

```{r hca_all}
all.hca.projects <- ShowHCAProjects()
head(all.hca.projects)
```

<hr />

### Summary attributes

`scfetch` provides `StatDBAttribute` to summary attributes of [Human Cell Atlas](https://www.humancellatlas.org/):

```{r hca_summary}
StatDBAttribute(df = all.hca.projects, filter = c("organism", "sex"), database = "HCA")
```

<hr />

### Extract metadata

`scfetch` provides `ExtractHCAMeta` to filter projects metadata, the available values of attributes can be obtained with `StatDBAttribute` except **cell number**:

```{r hca_meta}
# human 10x v2 and v3 datasets
hca.human.10x.projects <- ExtractHCAMeta(
  all.projects.df = all.hca.projects, organism = "Homo sapiens",
  protocol = c("10x 3' v2", "10x 3' v3")
)
head(hca.human.10x.projects)
```

<hr />

### Download object

After manually check the extracted metadata, users can **download the specified objects** with `ParseHCA`. The downloaded objects are controlled by `file.ext` (choose from `"rds"`, `"rdata"`, `"h5"`, `"h5ad"` and `"loom"`).

The returned result is a dataframe containing failed projects. If not `NULL`, users can re-run `ParseHCA` by setting `meta` to the returned result.

```{r hca_parse, eval=FALSE}
# no-run
ParseHCA(
  meta = all.human.10x.projects,
  out.folder = "/Users/soyabean/Desktop/tmp/scdown/download_hca"
)
```

The example structure of downloaded objects:
```{bash hca_parse_structure}
tree /Users/soyabean/Desktop/tmp/scdown/download_hca
```

<hr />





